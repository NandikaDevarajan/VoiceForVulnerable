@{
    ViewBag.Title = "Chatbot";
}
<main>
    <section class="msger">
        <header class="msger-header">
            <div class="msger-header-title">
                <i class="fas fa-comment-alt"></i> Voice for Vulnerable (By Nandika Devarajan)
            </div>
        </header>
        <div id="chat-box" class="msger-chat">
        </div>

        <div class="msger-inputarea">
            <input type="text" id="user-input" class="msger-input" placeholder="Type your question...">
            <button id="send-btn" class="msger-send-btn"><i class="fas fa-paper-plane"></i></button>
            <button id="voice-btn" class="msger-send-btn"><i class="fas fa-microphone"></i></button>
        </div>
        <div class="msger-inputarea">
            <button id="read-result-btn" class="msger-send-btn">Read / Stop Result</button>
        </div>
    </section>
</main>
<script>
    const chatBox = document.getElementById('chat-box');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const voiceBtn = document.getElementById('voice-btn');
    const readResultBtn = document.getElementById('read-result-btn');
    let lastBotResponse = ''; // To store the latest bot response for reading
    let speechSynthesisActive = false; // Track whether speech is ongoing

    // Handle send button click
    sendBtn.addEventListener('click', () =>
    {
        let question = userInput.value;
        if (question)
        {
            addUserMessageToChat(question);
            queryApi(question);
        }
    });

    // Handle voice input (Speech recognition)
    voiceBtn.addEventListener('click', () =>
    {
        const recognition = new webkitSpeechRecognition();
        recognition.lang = 'en-US';
        recognition.start();

        recognition.onresult = function (event)
        {
            const speechToText = event.results[0][0].transcript;
            userInput.value = speechToText;
            addUserMessageToChat(speechToText);
            queryApi(speechToText);
        }
    });

    // Function to add messages to the chat box
    function addUserMessageToChat(message)
    {
        const chatMessage = `<div class="msg left-msg"><div class="msg-img" style="background-image: url(../Assets/asset/images/avathar.webp)"></div><div class="msg-bubble"><div class="msg-info"><div class="msg-info-name">User</div></div><div class="msg-text">${message}</div></div></div>`;
        chatBox.innerHTML += chatMessage;
        chatBox.scrollTop = chatBox.scrollHeight; // Auto-scroll to the bottom
    }

    function addBotMessageToChat(message)
    {
        const chatMessage = `<div class="msg right-msg"><div class="msg-img" style="background-image: url(../Assets/asset/images/robot-chat.webp)"></div><div class="msg-bubble"><div class="msg-info"><div class="msg-info-name">PrepBot:</div></div><div class="msg-text">${message}</div></div></div>`;
        chatBox.innerHTML += chatMessage;
        chatBox.scrollTop = chatBox.scrollHeight; // Auto-scroll to the bottom
    }


    // Function to query your API
    function queryApi(question)
    {
        fetch('/Home/GetResponse', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ question })
        })
            .then(response => response.json())
            .then(data =>
            {
                addBotMessageToChat(data.response);
                lastBotResponse = data.response; // Store the last bot response for reading
            })
            .catch(error =>
            {
                addBotMessageToChat('An error occurred. Please try again.');
            });
    }

    // Handle read result button click (Text-to-Speech)
    readResultBtn.addEventListener('click', () =>
    {
        const synth = window.speechSynthesis;
        if (speechSynthesisActive)
        {
            // Stop the speech if it's already playing
            synth.cancel();
            speechSynthesisActive = false;
        } else if (lastBotResponse)
        {
            // Speak the bot's response if not already active
            const utterance = new SpeechSynthesisUtterance(lastBotResponse);
            synth.speak(utterance);
            speechSynthesisActive = true;

            utterance.onend = () =>
            {
                speechSynthesisActive = false; // Reset the flag when speech ends
            };
        }
    });
</script>
